#! UG/KF 19.0
#

defclass: common_functions();

Defun: com_sortStringList (
#+
DesignLogic=yes
-------------------------------------------------------------------------------
Description:
#.
sort a list of strings correctly by string length and ascending or Descending
.#
Example:
(List) sort: sortStringList({"Hello", "World"},Descending)
-------------------------------------------------------------------------------
#-
List $string_list; #.list of Strings to be sorted.#
Name $sort_direction #.Ascending or Descending.#
)

@{
 $names << Loop {
	For $name in $string_list;
	Collect {$name, length($name)};
 };
 $sorted << sort($names, $sort_direction, key, {second, first});
 Loop {
	For $name in $sorted;
	Collect first($name);
 };
} List;
#+
-------------------------------------------------------------------------------
Returns:
List - #.Sorted list of strings.#
-------------------------------------------------------------------------------
#-
# #####################################################################################################

Defun: com_makePoint (
#+
DesignLogic=yes
-------------------------------------------------------------------------------
Description:
#.
creates a point from a list of 3 doubles
.#
Example:
(Child) the_point: com_makePoint($coords)
-------------------------------------------------------------------------------
#-
List $pntArry #.list of 3 Numbers.#
)

@{
  if (length($pntArry) = 3 & typeCheck( nth(1,$pntArry), Number ) & typeCheck( nth(2,$pntArry), Number ) & typeCheck( nth(3,$pntArry), Number )) 
  then
	Point(nth(1,$pntArry),nth(2,$pntArry),nth(3,$pntArry))
  else
	0;
} Any;

# #####################################################################################################


Defun: com_transferVisMaterial (
#+
DesignLogic=yes
-------------------------------------------------------------------------------
Description:
#.
transfer visualization material from one solid body to a list of other solid bodies.
.#
Example:
(Boolean) transfer: com_transferVisMaterial()
-------------------------------------------------------------------------------
#-
Any $fromObject; #.solid body with visualization material.#
List $toObject #.list of solid bodies to transfer visualization material to.#
)

@{
  java_exec( "de.conti.tires.kite.common.Visualization", "transferMaterial", { $fromObject, $toObject} );
} Boolean;
#+
-------------------------------------------------------------------------------
Returns:
Boolean - #.False if an error occured else True.#
-------------------------------------------------------------------------------
#-
# #####################################################################################################

Defun: com_regexp (
#+
DesignLogic=yes
-------------------------------------------------------------------------------
Description:
#.
Search a string via regular expressions.
.#
Example:
(List) found: com_regexp("Hello World", "^[a-zA-Z].*")
-------------------------------------------------------------------------------
#-
String $searchString; #.string to search.#
String $regexp #.regular expression.#
)

@{
  java_exec( "de.conti.tires.kite.common.NXJAVA", "regexp", { $searchString, $regexp} );
} List;
#+
-------------------------------------------------------------------------------
Returns:
List - #.List of found matches.#
-------------------------------------------------------------------------------
#-

# #####################################################################################################

Defun: com_regexpList (
#+
DesignLogic=yes
-------------------------------------------------------------------------------
Description:
#.
Search a list of strings via regular expressions.
.#
Example:
(List) found: com_regexpList({"Hello", "World"}, "^[a-zA-Z].*")
-------------------------------------------------------------------------------
#-
List $searchStringList; #.list of strings to search.#
String $regexp #.regular expression.#
)

@{
  java_exec( "de.conti.tires.kite.common.NXJAVA", "regexpList", { $searchStringList, $regexp} );
} List;
#+
-------------------------------------------------------------------------------
Returns:
List - #.List of all items where one or more matches were found.#
-------------------------------------------------------------------------------
#-

# #####################################################################################################

Defun: com_isPointOnCurve(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
Tests whether a given point is on a given curve.
.#
Example:
(boolean) pointOnCurve?: com_isPointOnCurve(MyCurve:, $thePoint)
-------------------------------------------------------------------------------
#-
Any $curve, #.curve to find a point on.#
Point $the_point #.reference point .#
)
@{
	com_askclosestPointOnCurve($curve, $the_point) = $the_point;
}boolean;



# #####################################################################################################




defun: com_askClosestPointOnCurve(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
given a point, asks a curve for a point that is on the curve with the least distance to the given point.
.#
Example:
(Point) closest_point: com_askClosestPointOnCurve(MyCurve:, $thePoint)
-------------------------------------------------------------------------------
#-
Any $curve, #.curve to find a point on.#
Point $pnt #.reference point .#
)
@{
	$parm << ug_curve_askParameterAtPoint( $curve, $pnt );
	ug_curve_askPointOnCurve( $curve, $parm );
} Point;

# #####################################################################################################

defun: com_askHashValue(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
Poor mans implementation of a hash / key-value map.
Assumes that $hash is a list of tuples (lists of length 2) whose first element is the key.
If the key is used twice, only the first occurence will be used.
Please note that keys are case insensitive (due to KF not caring).
.#
Example:
(Point) startPoint: com_askHashValue("StartPoint", $thePoints)
-------------------------------------------------------------------------------
#-
Any $key, #..#
List $hash #..#
)
@{
	$keys << loop {
		for $pair in $hash;
		append{ first($pair)};
	};
	$positionOfKey << Position($key, $keys);
	if($positionOfKey == NoValue) then NoValue 
	else second( nth($positionOfKey, $hash)); 
} Any;


# #####################################################################################################

defun: com_Point2Vector(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
Converts a point into a Vector. Works with plain old Point, instances of nx_point and instances of ug_point.
Will return NoValue if the type is none of the above.
.#
Example:
(Vector) default_distance: com_Point2Vector(point(2,3,4))
-------------------------------------------------------------------------------
#-
Any $the_point #..#
)
@{      
      $the_type << com_robustAskType($the_point);
      $ret_val << if( $the_type = "Point") then
      	Vector(localx($the_point),localy($the_point),localz($the_point))
        else @{
	        if($the_type = "nx_point") then 
	        @{
		    $real_point << ref( $the_point, "Coordinates:" );
		    Vector(localx($real_point),localy($real_point),localz($real_point));
	        }
			else @{
	          if($the_type = "ug_point") then 
	          @{
				$real_point << ref( $the_point, "Position:" );
				Vector(localx($real_point),localy($real_point),localz($real_point));
	          }
			else  NoValue;
			};  
		};
     $ret_val;
} Any;




defun: com_robustAskType(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
A little bit more robust version of ug_objectAskType / TypeName.
If $the_instance actually is an Instance (i.e. TypeName($the_instance) returns Instance), 
it will use ug_object_askType to determine the type of instance (e.g. ug_feature), otherwise the TypeName. 
.#
(idiosyncratic) Example:
(String) type: com_robustAskType(point(2,3,4))
-------------------------------------------------------------------------------
#-
Any $the_instance #..#
)
@{
	$name_of_type << TypeName($the_instance);
	if($name_of_type = Instance  | $name_of_type = HostPointer ) then ug_object_askType($the_instance) else MakeString( $name_of_type);
} String;

# #####################################################################################################

defun: com_getSectionStartPoint(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
Converts a point into a Vector. Works with plain old Point, instances of nx_point and instances of ug_point.
Will return NoValue if the type is none of the above.
.#
Example:
(Vector) default_distance: com_Point2Vector(point(2,3,4))
-------------------------------------------------------------------------------
#-
List $curves, #.List of curves.#
Boolean $reverse? #.Reverse section.#
)
@{
 $coord_list << java_exec( "de.conti.tires.kite.common.NXJAVA", "getSectionStartPoint", { $curves, $reverse? } );
 com_makePoint($coord_list);
} Point;

# #####################################################################################################

defun: com_askBoundingBoxExact(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
Calculate max bounding box of the input objects. 
Does the same as ug_boundingBoxExact(), but for a list of objects.
.#
Example:
(List) bbox: com_askBoundingBoxExact({curve1:, Face1:, Solid1:});
-------------------------------------------------------------------------------
#-
List $objects #.List of objects.#
)
@{    
  $coord << loop {
	for $o in $objects;
	for $bbox is ug_askBoundingBoxExact( $o );
	for $min is first($bbox);
	for $max is second($bbox);
	append {{LocalX($min), LocalY($min), LocalZ($min)},{LocalX($max), LocalY($max), LocalZ($max)}};
  };

  $min_x << loop { For $m in $coord; Min_of nth(1, $m); };
  $min_y << loop { For $m in $coord; Min_of nth(2, $m); };
  $min_z << loop { For $m in $coord; Min_of nth(3, $m); };

  $max_x << loop { For $m in $coord; Max_of nth(1, $m); };
  $max_y << loop { For $m in $coord; Max_of nth(2, $m); };
  $max_z << loop { For $m in $coord; Max_of nth(3, $m); };

  {Point($min_x,$min_y,$min_z),Point($max_x,$max_y,$max_z)};

} List;



# #####################################################################################################

defun: com_arcLength(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
Calculates the length of an arc with angle 'angle' on a circle with radius 'radius'. 
.#
Example:

-------------------------------------------------------------------------------
#-
Number $radius,
Number $angle
)
@{
# maybe pre-compute constant values?
  $normed_angle << normalizeAngle($angle);
  $normed_angle * $radius * pi() / 180; # pi / 180 == Radians(1°)
} Number;


# #####################################################################################################

defun: com_arcCentralAngle(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
Calculates the central angle of an arc length 'length' on a circle with radius 'radius'. 
.#
Example:

-------------------------------------------------------------------------------
#-
Number $radius #. radius of circle.#
,Number $length #. length of circle segment to find corresponding angle for.#
)
@{
 # maybe pre-compute constant values?
  normalizeAngle( $length *180 / ($radius * pi()));
} Number;
#+ 
#-


defun: com_stringEqual(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
Case sensitive comparison of Strings.
.#
Example:

-------------------------------------------------------------------------------
#-
String $first, String $second)
@{
	compareString($first, $second) = 0;
} boolean;

defun: com_datetimestring()
@{
  charReplace(datetimestring()," :~n","___");
} String;

# #####################################################################################################

defun: com_deleteEmptyRefSets(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
Delete all empty Refsets
.#
-------------------------------------------------------------------------------
#-
)
@{
 java_exec( "de.conti.tires.kite.common.NXJAVA", "deleteEmptyRefSets", { } );
} Any;

# #####################################################################################################

defun: com_addExclusiveToRefSets(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
add all objects to the named refset and remove all objects from any other refset
if the refset does not exists it will be created
.#
-------------------------------------------------------------------------------
#-
String $refSetname, #.Reference Set Name.#
List $objs, #.Solid bodies.#
Boolean ($clearRefSet; false) #.Remove all bodies from refset before adding?.#
)
@{
	java_exec( "de.conti.tires.kite.common.NXJAVA", "addExclusiveToRefSet", { $refSetname , $objs, $clearRefSet} );
} Boolean;



# #####################################################################################################

defun: com_askBodiesOfRefSet(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
add all objects to the named refset and remove all objects from any other refset
if the refset does not exists it will be created
.#
-------------------------------------------------------------------------------
#-
String $refSetname, #.Reference Set Name.#
String $partName #.Name of Part to search in.#
)
@{
	java_exec( "de.conti.tires.kite.common.NXJAVA", "askObjectsOfRefSet", {  $refSetname, $partName } );
} List;

# #####################################################################################################

defun: com_filterHashEntries(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
removes hash-value pairs from the originalHash for the keys given in keysToRemove

.#
Example:
(List) filtered_constraints: com_filterHashKeys( {"angular_offset"}, original_constraints:);
-------------------------------------------------------------------------------
#-
List $keysToRemove,
List $originalHash #. a 'hash' like list of lists that is to be filtered. .#
)
@{	
	$newConstraints << loop {
		for $pair in $originalHash;
		for $key is first($pair);
		for $do_filter is loop{
			for $test_key in $keysToRemove;
			if $key = $test_key return true;
			return is false;
		};
		collect if ( - $do_filter) then $pair else {};
	};
  removeif(Empty?, $newConstraints);
} List;


# #####################################################################################################

defun: com_askSketchOfSketchFeature(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
add all objects to the named refset and remove all objects from any other refset
if the refset does not exists it will be created
.#
-------------------------------------------------------------------------------
#-
Any $sketchFeature #.Sketch Feature.#
)
@{
	java_exec( "de.conti.tires.kite.common.NXJAVA", "askSketchOfSketchFeature", {  $sketchFeature } );
} List;

# #####################################################################################################

defun: com_askCurvesAreChained?(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
check if a list of curves is chained

all end points are collected and compared by dist().
all duplicates are then removed
only 2 end points should remain!
.#
-------------------------------------------------------------------------------
#-
Any $curves #.List of chained curves.#
)
@{
	$pnts << loop {
      For $curve in $curves;
      Append {ug_curve_askStartPoint($curve),ug_curve_askEndPoint($curve)};
			#do c_visPoint(ug_curve_askStartPoint($curve), 80, 36);
			#do c_visPoint(ug_curve_askEndPoint($curve), 8, 188);
			Append {ug_curve_askStartPoint($curve),ug_curve_askEndPoint($curve)};
  };
	
	$end_pnts << loop {
    For $p in $pnts;
    for $counter from 1 to length($pnts);
    for $equal_pnts? is loop {
          for $p2 in $pnts;
          for $counter2 from 1 to length($pnts);
  
          for $equal? is if $counter = $counter2 then false else dist($p ,$p2) < 0.001;
          if $equal? return true;
          return is false;
    };
		do if !$equal_pnts? then debug_visPoint($p, 112, 44) else 0;
    if !$equal_pnts? Collect $p;
  };

	# if the curves are chained, only 2 ends should be available
  length($end_pnts) = 2;
} Boolean;
#+
-------------------------------------------------------------------------------
Returns:
Boolean - #.True if joinable..#
-------------------------------------------------------------------------------
#-

defun: com_reverseString(String $text)
@{
	# convert to list, then revert that list
	$text_list << reverse(splitString($text,""));
	# now put it back together as a String	
	# with the funky KF syntax...
	loop{
    with $new_text is "";
    for $character in $text_list;
    for $new_Text is $new_text + $character;
    return is $new_text;
 };		
} String;


# #####################################################################################################

defun: com_setExpressionFormula(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
set formula of existing expression
.#
-------------------------------------------------------------------------------
#-
Any $expression, #.Expression.#
String $formula #.Formula of expression.#
)
@{
	java_exec( "de.conti.tires.kite.common.NXJAVA", "setExpressionFormula", {  $expression, $formula } );
} Boolean;

# #####################################################################################################

defun: com_setFeatureName(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
set name of Feature

DEBUGGING PURPOSE
.#
-------------------------------------------------------------------------------
#-
Any $feature #.Feature Hostpointer of Instance.#
)
@{
	java_exec( "de.conti.tires.kite.common.NXJAVA", "setFeatureName", {  $feature	} );
} Boolean;

# #####################################################################################################

defun: com_askInstanceByClassName(
#+
DesignLogic=no
-------------------------------------------------------------------------------
Description:
#.
ask for all Instance by its class name,
the class name is a regular expression
.#

Example: get the tpd_project_setup instance
(Any) instance: com_askInstanceByClassName("^tpd_project_setup.*");
-------------------------------------------------------------------------------
#-
String $class_name #.Regular expression of class name.#
)
@{
  #Loop {
  #  For $obj In root:children:;
  #  For $class is MakeString(ug_askInstanceClass( $obj ));
  #  if length(com_regexp( $class, $class_name_regexp )) = 1 Collect $obj;
  #};
	Loop {
    For $obj In root:children:;
    For $class is MakeString(ug_askInstanceClass( $obj ));
    For $class_short is subString( $class, 1, length($class_name) );
    if $class_short = $class_name Collect $obj;
  };
} List;
#+
-------------------------------------------------------------------------------
Returns:
List - #.List of all found Instances.#
-------------------------------------------------------------------------------
#-

